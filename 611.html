<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹”å¢ƒ Taijing | å®šåˆ¶ä½ çš„ä¸“å±å¾®æ™¯è§‚</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&display=swap');

        :root {
            --moss-dark: #1e3a29;
            --moss-light: #4a7c59;
            --stone-bg: #f5f5f0;
            --accent-gold: #c5a065;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--stone-bg);
            color: #2d3436;
        }

        h1, h2, h3, .serif {
            font-family: 'Noto Serif SC', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes grow {
            from { transform: scale(0.95); opacity: 0.5; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-grow {
            animation: grow 0.4s ease-out forwards;
        }

        /* Chart Container Styling - MANDATORY */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        
        /* Moss Texture Simulation Classes */
        .texture-moss-1 {
            background-color: #386641;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%236a994e' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20H20v-1.41zM20 21.4l2.83 2.83-1.41-1.41L21.41 20H20v1.41z'/%3E%3C/g%3E%3C/svg%3E");
        }
        .texture-moss-2 {
            background-color: #1e3a29;
            background-image: radial-gradient(#4a7c59 1px, transparent 1px);
            background-size: 10px 10px;
        }
        .texture-stone {
            background-color: #7f8c8d;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2395a5a6' fill-opacity='0.4' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
    <!-- Chosen Palette: Earthy Moss tones (Deep Green #1e3a29, Sage #4a7c59) with Stone Grey backgrounds and Gold accents for premium feel. -->
    <!-- Application Structure Plan: Linear 4-Stage Process (Select -> Analyze -> Edit -> Export). Chosen for high-end customization to guide user through complexity. Dashboard elements integrated in Stage 2 & 3. -->
    <!-- Visualization & Content Choices:
        1. Material Analysis: Doughnut Chart to visualize the "Recipe" of the moss art (Greenery vs Hardscape).
        2. Texture Density: Radar Chart to compare style attributes (Wildness, Density, Color pop).
        3. Canvas Interaction: HTML5 Canvas for the "Graffiti" and drawing features required by user.
        4. No SVG/Mermaid: All icons FontAwesome or CSS shapes.
    -->
    <!-- CONFIRMATION: NO SVG graphics used (except data URIs for CSS background patterns). NO Mermaid JS used. -->
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-stone-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="app.reset()">
                    <i class="fa-solid fa-seedling text-3xl text-emerald-800 mr-3"></i>
                    <div>
                        <span class="font-bold text-2xl tracking-widest text-emerald-900 serif">è‹”å¢ƒ</span>
                        <span class="block text-xs text-stone-500 tracking-wider">TAIJING MOSS ART</span>
                    </div>
                </div>
                <div class="hidden md:flex space-x-8">
                    <!-- Steps Indicator -->
                    <div class="flex items-center space-x-2 text-sm font-medium">
                        <span id="step-nav-1" class="text-emerald-800 border-b-2 border-emerald-800 pb-1">1. é£æ ¼é€‰æ‹©</span>
                        <i class="fa-solid fa-chevron-right text-stone-300 text-xs"></i>
                        <span id="step-nav-2" class="text-stone-400 pb-1">2. ç´ æåˆ†æ</span>
                        <i class="fa-solid fa-chevron-right text-stone-300 text-xs"></i>
                        <span id="step-nav-3" class="text-stone-400 pb-1">3. åˆ›ä½œå·¥åŠ</span>
                        <i class="fa-solid fa-chevron-right text-stone-300 text-xs"></i>
                        <span id="step-nav-4" class="text-stone-400 pb-1">4. äº¤ä»˜</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <button class="p-2 rounded-full text-stone-500 hover:text-emerald-800 transition">
                        <i class="fa-regular fa-user"></i>
                    </button>
                    <button class="ml-4 p-2 rounded-full text-stone-500 hover:text-emerald-800 transition">
                        <i class="fa-solid fa-bag-shopping"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Views will be injected here by JS -->
    </main>

    <!-- Footer -->
    <footer class="bg-stone-900 text-stone-400 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="serif italic text-lg mb-2">"è®©è‡ªç„¶å›å½’ç”Ÿæ´»"</p>
            <p class="text-xs tracking-wider opacity-60">Â© 2025 Taijing Moss Art Design. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- Tripo AI é…ç½® ---
        const TRIPO_CONFIG = {
            // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼šæœ¬åœ°å¼€å‘ç”¨localhostï¼Œçº¿ä¸Šç”¨ç›¸å¯¹è·¯å¾„
            baseUrl: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000/api'  // æœ¬åœ°å¼€å‘
                : '/api',  // çº¿ä¸Šéƒ¨ç½²ï¼ˆNetlify Functionsï¼‰
            // 2Dè½¬3Dçš„æç¤ºè¯é…ç½® ğŸ‘‡
            defaultPrompt: 'åŸºäºè‹”è—“å¾®æ™¯è§‚è®¾è®¡ï¼Œä¿æŒè‡ªç„¶è´¨æ„Ÿå’Œç»†èŠ‚ï¼Œé€‚åˆ3Dæ‰“å°å’ŒCNCåŠ å·¥',
            // æ¨¡å‹ç”Ÿæˆå‚æ•° ğŸ‘‡
            modelParams: {
                mode: 'refine',  // ç²¾ç»†æ¨¡å¼ (æˆ– 'preview' å¿«é€Ÿé¢„è§ˆ)
                format: 'glb'    // å¯¼å‡ºæ ¼å¼: glb, obj, fbx, stl, usdz
            }
        };

        // --- Data & State ---
        const MOSS_STYLES = [
            {
                id: 'zen',
                name: 'æ¯å±±æ°´ â€¢ ç¦…æ„',
                desc: 'æç®€ç•™ç™½ï¼Œä»¥çŸ³ä¸ºå±±ï¼Œä»¥è‹”ä¸ºæ°´ã€‚é€‚åˆé™æ€å†¥æƒ³ç©ºé—´ã€‚',
                bgClass: 'bg-stone-100',
                patternClass: 'texture-stone',
                primaryColor: '#7f8c8d',
                composition: { moss: 30, stone: 50, wood: 10, space: 10 },
                attributes: [20, 40, 90, 30, 80] // [Density, Color, Calm, Wild, Texture]
            },
            {
                id: 'forest',
                name: 'è¿·é›¾æ£®æ— â€¢ æ·±é‚ƒ',
                desc: 'æ¨¡æ‹ŸåŸå§‹æ£®æ—åœ°è²Œï¼Œå±‚æ¬¡ä¸°å¯Œï¼Œå……æ»¡ç”Ÿæœºã€‚é«˜å¯†åº¦æ¤è¢«è¦†ç›–ã€‚',
                bgClass: 'bg-emerald-900',
                patternClass: 'texture-moss-1',
                primaryColor: '#1e3a29',
                composition: { moss: 70, stone: 10, wood: 20, space: 0 },
                attributes: [90, 80, 50, 90, 95]
            },
            {
                id: 'modern',
                name: 'å‡ ä½• â€¢ ç°ä»£',
                desc: 'å°†è‡ªç„¶å…ƒç´ èå…¥ç°ä»£å‡ ä½•æ¡†æ¶ã€‚çº¿æ¡åˆ©è½ï¼Œè‰²å½©é²œæ˜ã€‚',
                bgClass: 'bg-teal-700',
                patternClass: 'texture-moss-2',
                primaryColor: '#4a7c59',
                composition: { moss: 50, stone: 0, wood: 20, space: 30 },
                attributes: [60, 60, 40, 20, 50]
            }
        ];

        const MATERIALS_DB = {
            base: [
                { id: 'sheet_moss', name: 'å¤§ç°è—“', type: 'moss', color: '#4a7c59' },
                { id: 'mood_moss', name: 'ç™½å‘è—“ (çƒè‹”)', type: 'moss', color: '#88a876' },
                { id: 'reindeer_moss', name: 'é©¯é¹¿è‹”', type: 'moss', color: '#cddc39' }
            ],
            decor: [
                { id: 'fern', name: 'æ°¸ç”Ÿè•¨ç±»', type: 'plant', icon: 'fa-leaf' },
                { id: 'driftwood', name: 'æ²‰æœ¨æ', type: 'wood', icon: 'fa-tree' },
                { id: 'seiryu', name: 'é’é¾™çŸ³', type: 'stone', icon: 'fa-cubes' },
                { id: 'crystal', name: 'æ°´æ™¶ç¢çŸ³', type: 'stone', icon: 'fa-gem' }
            ]
        };
//çŠ¶æ€ç®¡ç†
        const appState = {
            step: 1,
            generated3DModel: null,  // å­˜å‚¨ç”Ÿæˆçš„3Dæ¨¡å‹ä¿¡æ¯
            is3DGenerating: false,   // 3Dç”ŸæˆçŠ¶æ€
            productType: 'painting', // æ–°å¢ï¼šé»˜è®¤ä¸ºè‹”è—“ç”»
            selectedStyle: null,
            selectedMaterials: new Set(), // é€‰ä¸­çš„ç´ æé›†åˆ
            canvasCtx: null,
            isDrawing: false,
            drawMode: 'brush', // brush, eraser, text, region
            customPaths: [], // Store drawing paths
            // æ–°å¢ï¼šæ–‡å­—æ ‡æ³¨å’ŒåŒºåŸŸæ ‡è®°ç›¸å…³çŠ¶æ€
            annotations: [], // å­˜å‚¨æ‰€æœ‰æ ‡æ³¨ {type: 'text'|'region', x, y, width?, height?, content?, path?}
            currentRegion: null, // å½“å‰æ­£åœ¨ç»˜åˆ¶çš„åŒºåŸŸ
            regionStart: null, // åŒºåŸŸèµ·å§‹ç‚¹
            currentRegionPath: [], // å½“å‰æ­£åœ¨ç»˜åˆ¶çš„è‡ªç”±åŒºåŸŸè·¯å¾„
            brushColor: '#ef4444', // ç”»ç¬”é¢œè‰²
            pendingTextPosition: null, // ç­‰å¾…è¾“å…¥æ–‡å­—çš„ä½ç½®
            isGeneratingInpaint: false // æ˜¯å¦æ­£åœ¨è¿›è¡Œå›¾ç”Ÿå›¾
        };

        // --- Core Application Logic ---
//åº”ç”¨å¯¹è±¡ç»“æ„ 
        const app = {
            init: () => {
                app.renderStep1();
            },

            reset: () => {
                appState.step = 1;
                appState.productType = 'painting'; // é‡ç½®ç±»å‹
                appState.selectedStyle = null;
                appState.selectedMaterials.clear();
                appState.customPaths = [];
                appState.annotations = [];
                appState.currentRegion = null;
                appState.regionStart = null;
                appState.currentRegionPath = [];
                appState.pendingTextPosition = null;
                appState.isGeneratingInpaint = false;
                app.updateNav();
                app.renderStep1();
            },
//
            updateNav: () => {
                const steps = [1, 2, 3, 4];
                steps.forEach(s => {
                    const el = document.getElementById(`step-nav-${s}`);
                    if (s === appState.step) {
                        el.className = 'text-emerald-800 border-b-2 border-emerald-800 pb-1 transition-all duration-300';
                    } else if (s < appState.step) {
                        el.className = 'text-emerald-600 pb-1 cursor-pointer transition-all duration-300';
                        el.onclick = () => app.goToStep(s);
                    } else {
                        el.className = 'text-stone-300 pb-1 transition-all duration-300';
                        el.onclick = null;
                    }
                });
            },

            goToStep: (step) => {
                appState.step = step;
                app.updateNav();
                if (step === 1) app.renderStep1();
                if (step === 2) app.renderStep2();
                if (step === 3) app.renderStep3();
                if (step === 4) app.renderStep4();
            },
//å››ä¸ªè§†å›¾çš„æ¸²æŸ“
            // --- VIEW 1: Style Selection ---
            renderStep1: () => {
                const container = document.getElementById('app-container');
                const isPainting = appState.productType === 'painting';

                container.innerHTML = `
                    <div class="text-center mb-10 animate-fade-in">
                        <h2 class="text-3xl md:text-4xl font-bold text-emerald-950 mb-4 serif">é€‰æ‹©æ‚¨çš„è‡ªç„¶æ„å¢ƒ</h2>
                        <p class="text-stone-500 max-w-2xl mx-auto mb-8">æ¯ä¸€æ¬¾ä½œå“éƒ½æ˜¯ä¸€ä¸ªå¾®ç¼©çš„è‡ªç„¶ä¸–ç•Œã€‚è¯·å®šåˆ¶æ‚¨çš„ä¸“å±ç»¿æ„ã€‚</p>
                        
                        <!-- Type Selection Toggle -->
                        <div class="inline-flex bg-stone-200/50 p-1.5 rounded-full shadow-inner border border-stone-200">
                            <button onclick="app.selectProductType('painting')" 
                                class="px-8 py-2.5 rounded-full text-sm font-bold tracking-wide transition-all duration-300 flex items-center ${isPainting ? 'bg-white text-emerald-900 shadow-md scale-105' : 'text-stone-500 hover:text-stone-700 hover:bg-stone-200/50'}">
                                <i class="fa-solid fa-image mr-2 ${isPainting ? 'text-emerald-600' : ''}"></i>è‹”è—“ç”»
                            </button>
                            <button onclick="app.selectProductType('terrarium')" 
                                class="px-8 py-2.5 rounded-full text-sm font-bold tracking-wide transition-all duration-300 flex items-center ${!isPainting ? 'bg-white text-emerald-900 shadow-md scale-105' : 'text-stone-500 hover:text-stone-700 hover:bg-stone-200/50'}">
                                <i class="fa-solid fa-cube mr-2 ${!isPainting ? 'text-emerald-600' : ''}"></i>è‹”è—“æ™¯è§‚
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                        ${MOSS_STYLES.map(style => `
                            <div onclick="app.selectStyle('${style.id}')" 
                                 class="group relative h-96 rounded-2xl overflow-hidden cursor-pointer shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border-4 ${appState.selectedStyle?.id === style.id ? 'border-emerald-600' : 'border-transparent'}">
                                
                                <!-- Visual Representation (CSS Pattern) -->
                                <div class="absolute inset-0 ${style.bgClass} ${style.patternClass} opacity-90 transition-transform duration-700 group-hover:scale-110"></div>
                                <div class="absolute inset-0 bg-gradient-to-t from-stone-900 via-transparent to-transparent opacity-80"></div>
                                
                                <!-- Content -->
                                <div class="absolute bottom-0 left-0 p-8 w-full text-white z-10">
                                    <div class="flex justify-between items-end">
                                        <div>
                                            <h3 class="text-2xl font-bold serif mb-2 tracking-wide group-hover:text-emerald-300 transition-colors">${style.name}</h3>
                                            <p class="text-sm text-stone-300 opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-4 group-hover:translate-y-0">${style.desc}</p>
                                        </div>
                                        <div class="opacity-0 group-hover:opacity-100 transition-all duration-300">
                                            <i class="fa-solid fa-circle-check text-3xl text-emerald-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex justify-center mt-8">
                        <button id="btn-step-1" onclick="app.confirmStyle()" disabled class="px-12 py-4 rounded-full bg-stone-300 text-stone-500 font-bold tracking-widest transition-all cursor-not-allowed">
                            ç¡®è®¤é£æ ¼ <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                `;
            },

            selectStyle: (id) => {
                appState.selectedStyle = MOSS_STYLES.find(s => s.id === id);
                app.renderStep1(); // Re-render to show selection
                const btn = document.getElementById('btn-step-1');
                if (btn) {
                    btn.disabled = false;
                    btn.className = "px-12 py-4 rounded-full bg-emerald-800 hover:bg-emerald-900 text-white font-bold tracking-widest shadow-lg transform hover:scale-105 transition-all";
                }
            },

            selectProductType: (type) => {
                appState.productType = type;
                app.renderStep1();
            },

            confirmStyle: () => {
                if (!appState.selectedStyle) return;
                // Add default materials based on style
                appState.selectedMaterials.clear();
                if (appState.selectedStyle.id === 'forest') {
                    appState.selectedMaterials.add('fern');
                    appState.selectedMaterials.add('driftwood');
                } else if (appState.selectedStyle.id === 'zen') {
                    appState.selectedMaterials.add('seiryu');
                }
                app.goToStep(2);
            },

            // --- VIEW 2: Analysis & Material ---
            renderStep2: () => {
                const style = appState.selectedStyle;
                const container = document.getElementById('app-container');
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in h-full">
                        <!-- Left: Visual & Charts -->
                        <div class="lg:col-span-4 flex flex-col space-y-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                <h3 class="text-lg font-bold text-emerald-900 mb-4 serif border-b pb-2">AI è§†è§‰åˆ†ææŠ¥å‘Š</h3>
                                <p class="text-sm text-stone-500 mb-6">ç³»ç»Ÿå·²åŸºäº<span class="font-bold text-emerald-700">â€œ${style.name}â€</span>é£æ ¼ä¸ºæ‚¨ç”Ÿæˆåˆå§‹æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯è¯¥é£æ ¼çš„å…ƒç´ æ„æˆåˆ†æã€‚</p>
                                
                                <div class="chart-container mb-6">
                                    <canvas id="compositionChart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <canvas id="attributeChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Material Customization -->
                        <div class="lg:col-span-8">
                            <div class="bg-white p-8 rounded-2xl shadow-lg border border-stone-100 h-full flex flex-col">
                                <div class="mb-6">
                                    <h2 class="text-2xl font-bold text-emerald-900 serif">ç´ æé…ç½®åº“</h2>
                                    <p class="text-stone-500">ç‚¹å‡»ä¸‹æ–¹ç´ æå¡ç‰‡ï¼Œå®šåˆ¶æ‚¨çš„å¾®æ™¯è§‚å…ƒç´ ã€‚</p>
                                </div>

                                <!-- Dynamic Material List -->
                                <div class="space-y-8 flex-grow">
                                    
                                    <!-- Base Moss -->
                                    <div>
                                        <h4 class="text-sm font-bold text-stone-400 uppercase tracking-widest mb-3">åŸºç¡€åº•è‹” (Essential)</h4>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            ${MATERIALS_DB.base.map(m => `
                                                <div class="p-3 rounded-xl border border-stone-200 bg-stone-50 flex items-center space-x-3 opacity-75 cursor-default">
                                                    <div class="w-8 h-8 rounded-full" style="background-color: ${m.color}"></div>
                                                    <span class="text-stone-700 font-medium">${m.name}</span>
                                                    <i class="fa-solid fa-check text-emerald-500 ml-auto"></i>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <!-- Decor Items (Interactive) -->
                                    <div>
                                        <h4 class="text-sm font-bold text-stone-400 uppercase tracking-widest mb-3">è£…é¥°ç‚¹ç¼€ (Optional)</h4>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            ${MATERIALS_DB.decor.map(m => {
                                                const isSelected = appState.selectedMaterials.has(m.id);
                                                return `
                                                <div onclick="app.toggleMaterial('${m.id}')" 
                                                     class="p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 flex items-center justify-between
                                                     ${isSelected ? 'border-emerald-500 bg-emerald-50' : 'border-stone-200 hover:border-emerald-300 bg-white'}">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="w-10 h-10 rounded-lg bg-stone-200 flex items-center justify-center text-stone-600">
                                                            <i class="fa-solid ${m.icon}"></i>
                                                        </div>
                                                        <div class="flex flex-col">
                                                            <span class="font-bold text-stone-800">${m.name}</span>
                                                            <span class="text-xs text-stone-400">${isSelected ? 'å·²åŠ å…¥' : 'ç‚¹å‡»æ·»åŠ '}</span>
                                                        </div>
                                                    </div>
                                                    ${isSelected ? '<i class="fa-solid fa-circle-plus text-emerald-600"></i>' : '<i class="fa-regular fa-circle text-stone-300"></i>'}
                                                </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Action -->
                                <div class="mt-8 pt-6 border-t border-stone-100 flex justify-between items-center">
                                    <div class="text-sm text-stone-500">
                                        å·²é€‰æ‹© <span class="font-bold text-emerald-700 text-lg">${appState.selectedMaterials.size}</span> ç§é¢å¤–è£…é¥°
                                    </div>
                                    <button onclick="app.generatePreview()" class="px-8 py-3 bg-emerald-800 text-white rounded-lg shadow-lg hover:bg-emerald-900 transition flex items-center">
                                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ç”Ÿæˆè®¾è®¡æ ·å›¾
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Render Charts after DOM injection
                app.renderCharts(style);
            },

            toggleMaterial: (id) => {
                if (appState.selectedMaterials.has(id)) {
                    appState.selectedMaterials.delete(id);
                } else {
                    appState.selectedMaterials.add(id);
                }
                app.renderStep2(); // Re-render to update UI and Charts
            },

            renderCharts: (style) => {
                // Adjust data based on selected materials
                let comp = { ...style.composition };
                if (appState.selectedMaterials.has('seiryu') || appState.selectedMaterials.has('crystal')) comp.stone += 15;
                if (appState.selectedMaterials.has('driftwood')) comp.wood += 15;
                if (appState.selectedMaterials.has('fern')) comp.moss -= 10; // Ferns take moss space

                // Donut Chart: Material Composition
                new Chart(document.getElementById('compositionChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['è‹”è—“æ¤è¢«', 'å±±çŸ³è‚Œç†', 'æ¯æœ¨ç»“æ„', 'ç•™ç™½ç©ºé—´'],
                        datasets: [{
                            data: [comp.moss, comp.stone, comp.wood, comp.space],
                            backgroundColor: ['#4a7c59', '#95a5a6', '#8d6e63', '#f5f5f0'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });

                // Radar Chart: Style Attributes
                new Chart(document.getElementById('attributeChart'), {
                    type: 'radar',
                    data: {
                        labels: ['æ¤è¢«å¯†åº¦', 'è‰²å½©ä¸°å¯Œåº¦', 'é™è°§æ„Ÿ', 'é‡æ€§åº¦', 'çº¹ç†å¤æ‚åº¦'],
                        datasets: [{
                            label: style.name,
                            data: style.attributes,
                            backgroundColor: 'rgba(74, 124, 89, 0.2)',
                            borderColor: '#1e3a29',
                            pointBackgroundColor: '#1e3a29',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { r: { suggestedMin: 0, suggestedMax: 100 } }
                    }
                });
            },

            generatePreview: async () => {
                // Call FAL AI API via VectorEngine
                const btn = document.querySelector('button[onclick="app.generatePreview()"]');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> AI æ¸²æŸ“ä¸­...';
                btn.disabled = true;

                try {
                    const imageUrl = await app.callFalAI();
                    appState.generatedImageUrl = imageUrl;
                    app.goToStep(3);
                } catch (error) {
                    console.error('API è°ƒç”¨å¤±è´¥:', error);
                    btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-2"></i> ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
                    btn.disabled = false;
                    alert('å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ' + error.message);
                }
            },

            callFalAI: async () => {
                const API_KEY = 'sk-d7leMiEV2bAHJ44cRfWP5sVJ4pQc250cS8mPRzpNTDF3A0ou';
                const prompt = app.buildPrompt(appState.selectedStyle);
                
                try {
                    console.log('å‘é€ Gemini API è¯·æ±‚...');
                    
                    // è®¾ç½® 60 ç§’è¶…æ—¶ï¼ˆGemini ç”Ÿæˆéœ€è¦ 40+ ç§’ï¼‰
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);
                    
                    const response = await fetch('https://api.vectorengine.ai/v1beta/models/gemini-3-pro-image-preview:generateContent', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.8,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192
                            }
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('API å“åº”çŠ¶æ€:', response.status);

                    const result = await response.json();
                    console.log('API å“åº”æ•°æ®:', result);

                    if (!response.ok) {
                        let errorMsg = `HTTP ${response.status}`;
                        if (result.error) {
                            errorMsg += `\né”™è¯¯ç±»å‹: ${result.error.type || 'æœªçŸ¥'}`;
                            errorMsg += `\né”™è¯¯ä¿¡æ¯: ${result.error.message_zh || result.error.message || 'æ— è¯¦ç»†ä¿¡æ¯'}`;
                        } else {
                            errorMsg += `\nå“åº”å†…å®¹: ${JSON.stringify(result)}`;
                        }
                        throw new Error(errorMsg);
                    }

                    // è§£æå›¾ç‰‡ï¼ˆæ”¯æŒé©¼å³°å’Œä¸‹åˆ’çº¿ä¸¤ç§å‘½åï¼‰
                    if (result.candidates && result.candidates[0]) {
                        const candidate = result.candidates[0];
                        
                        if (candidate.content && candidate.content.parts) {
                            for (const part of candidate.content.parts) {
                                // å…¼å®¹é©¼å³°å‘½å inlineData
                                if (part.inlineData && part.inlineData.data) {
                                    const mimeType = part.inlineData.mimeType || 'image/png';
                                    return `data:${mimeType};base64,${part.inlineData.data}`;
                                }
                                // å…¼å®¹ä¸‹åˆ’çº¿å‘½å inline_data
                                if (part.inline_data && part.inline_data.data) {
                                    const mimeType = part.inline_data.mime_type || 'image/png';
                                    return `data:${mimeType};base64,${part.inline_data.data}`;
                                }
                                // å›¾ç‰‡ URL
                                if (part.image_url || part.imageUrl) {
                                    return part.image_url || part.imageUrl;
                                }
                            }
                        }
                    }
                    
                    throw new Error('å“åº”ä¸­æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®\nå“åº”ç»“æ„: ' + JSON.stringify(result).substring(0, 200));
                    
                } catch (error) {
                    let detailedError = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥\n\n';
                    
                    if (error.name === 'AbortError') {
                        detailedError += 'åŸå› : è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡ 60 ç§’ï¼‰\n';
                        detailedError += 'è¯´æ˜: æœåŠ¡å™¨ç”Ÿæˆå›¾ç‰‡æ—¶é—´è¿‡é•¿\n';
                        detailedError += 'å»ºè®®: è¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ';
                    } else if (error.message === 'Failed to fetch') {
                        detailedError += 'åŸå› : ç½‘ç»œè¯·æ±‚å¤±è´¥\n';
                        detailedError += 'å¯èƒ½åŸå› :\n';
                        detailedError += '  â€¢ ç½‘ç»œè¿æ¥ä¸­æ–­\n';
                        detailedError += '  â€¢ æµè§ˆå™¨é»˜è®¤è¶…æ—¶ï¼ˆé€šå¸¸ 30 ç§’ï¼‰\n';
                        detailedError += '  â€¢ API æœåŠ¡å™¨æ— å“åº”\n';
                        detailedError += '  â€¢ CORS è·¨åŸŸé™åˆ¶\n';
                        detailedError += 'å»ºè®®: æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                    } else {
                        detailedError += 'é”™è¯¯è¯¦æƒ…:\n' + error.message;
                    }
                    
                    console.error('è¯¦ç»†é”™è¯¯:', detailedError);
                    throw new Error(detailedError);
                }
            },

            buildPrompt: (style) => {
                const materials = Array.from(appState.selectedMaterials)
                    .map(m => {
                        const item = [...MATERIALS_DB.base, ...MATERIALS_DB.decor].find(x => x.id === m);
                        return item ? item.name : m;
                    })
                    .join(', ');

                // æ ¹æ®äº§å“ç±»å‹è°ƒæ•´ Prompt å‰ç¼€
                const typePrompt = appState.productType === 'painting' 
                    ? "framed moss wall art, vertical garden painting, hanging on wall, flat composition, rectangular frame" 
                    : "glass terrarium container, miniature moss landscape, 3d object, table top decoration, inside glass vessel";

                const stylePrompts = {
                    zen: 'minimalist zen style moss garden, karesansui, green moss and grey stones, Japanese garden art, serene and calm',
                    forest: 'mysterious deep rainforest terrarium, dense green vegetation, primeval forest atmosphere, light through leaves',
                    modern: 'modern geometric style, minimalism, clean lines, moss integrated with architectural elements'
                };

                return `A beautiful ${typePrompt}, ${stylePrompts[style.id]}. Materials: ${materials || 'moss, stones'}. 2K quality, professional product photography, soft lighting, studio background, ultra detailed`;
            },

            // --- VIEW 3: Studio & Canvas ---
            renderStep3: () => {
                const container = document.getElementById('app-container');
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]">
                        <!-- Toolbar -->
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-4 flex flex-col space-y-4 overflow-y-auto">
                            <h3 class="font-bold text-emerald-900 border-b pb-2">åˆ›ä½œå·¥å…·</h3>
                            
                            <div class="space-y-2">
                                <p class="text-xs text-stone-400 font-bold uppercase">è°ƒæ•´å‚æ•°</p>
                                <div>
                                    <label class="text-xs text-stone-600">æ¤è¢«å¯†åº¦</label>
                                    <input type="range" class="w-full accent-emerald-600" oninput="app.redrawCanvas()">
                                </div>
                                <div>
                                    <label class="text-xs text-stone-600">å…‰ç…§å¼ºåº¦</label>
                                    <input type="range" class="w-full accent-emerald-600">
                                </div>
                            </div>

                            <div class="space-y-2 pt-4 border-t border-stone-100">
                                <p class="text-xs text-stone-400 font-bold uppercase">æ¶‚é¸¦æ ‡è®° (Graffiti)</p>
                                <button onclick="app.setTool('brush')" id="tool-brush" class="w-full text-left px-3 py-2 rounded bg-emerald-100 text-emerald-800 transition"><i class="fa-solid fa-pen mr-2"></i> æ ‡è®°ç¬”</button>
                                <button onclick="app.setTool('eraser')" id="tool-eraser" class="w-full text-left px-3 py-2 rounded hover:bg-stone-100 text-stone-600 transition"><i class="fa-solid fa-eraser mr-2"></i> æ©¡çš®æ“¦</button>
                            </div>

                            <!-- æ–°å¢ï¼šBanana Pro é£æ ¼æ ‡æ³¨å·¥å…· -->
                            <div class="space-y-2 pt-4 border-t border-stone-100">
                                <p class="text-xs text-stone-400 font-bold uppercase">æ™ºèƒ½æ ‡æ³¨ (Smart Marker)</p>
                                <button onclick="app.setTool('text')" id="tool-text" class="w-full text-left px-3 py-2 rounded hover:bg-stone-100 text-stone-600 transition"><i class="fa-solid fa-font mr-2"></i> æ–‡å­—æ ‡æ³¨</button>
                                <button onclick="app.setTool('region')" id="tool-region" class="w-full text-left px-3 py-2 rounded hover:bg-stone-100 text-stone-600 transition"><i class="fa-solid fa-vector-square mr-2"></i> æ¡†é€‰åŒºåŸŸ</button>
                                
                                <!-- é¢œè‰²é€‰æ‹© -->
                                <div class="flex items-center space-x-2 mt-2">
                                    <label class="text-xs text-stone-600">æ ‡æ³¨é¢œè‰²:</label>
                                    <input type="color" id="brush-color" value="#ef4444" onchange="app.setBrushColor(this.value)" class="w-8 h-8 rounded cursor-pointer border-0">
                                </div>
                            </div>
                            
                            <div class="space-y-2 pt-4 border-t border-stone-100">
                                <p class="text-xs text-stone-400 font-bold uppercase">AI å›¾ç”Ÿå›¾</p>
                                <button onclick="app.generateInpaint()" id="btn-inpaint" class="w-full text-left px-3 py-2 rounded bg-purple-100 text-purple-800 hover:bg-purple-200 transition"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i> åŒºåŸŸé‡ç»˜</button>
                                <p class="text-xs text-stone-400 mt-1">æ¡†é€‰åŒºåŸŸå¹¶æ·»åŠ æè¿°ï¼ŒAIå°†æ ¹æ®æ ‡æ³¨é‡æ–°ç”Ÿæˆ</p>
                            </div>

                            <div class="space-y-2 pt-4 border-t border-stone-100">
                                <button onclick="app.clearGraffiti()" class="w-full text-left px-3 py-2 rounded hover:bg-red-50 text-red-500 transition"><i class="fa-solid fa-trash mr-2"></i> æ¸…é™¤æ‰€æœ‰æ ‡è®°</button>
                                <button onclick="app.undoLastAnnotation()" class="w-full text-left px-3 py-2 rounded hover:bg-orange-50 text-orange-500 transition"><i class="fa-solid fa-rotate-left mr-2"></i> æ’¤é”€ä¸Šä¸€æ­¥</button>
                            </div>

                            <div class="mt-auto">
                                <button onclick="app.regenerateWithAnnotations()" class="w-full py-2 border border-emerald-600 text-emerald-600 rounded hover:bg-emerald-50 transition mb-2">
                                    <i class="fa-solid fa-rotate mr-1"></i> é‡æ–°ç”Ÿæˆ
                                </button>
                                <button onclick="app.goToStep(4)" class="w-full py-3 bg-emerald-800 text-white rounded shadow-lg hover:bg-emerald-900 transition">
                                    <i class="fa-solid fa-check mr-1"></i> ç¡®è®¤å®šç¨¿
                                </button>
                            </div>
                        </div>

                        <!-- Main Canvas Area -->
                        <div class="lg:col-span-10 bg-stone-200 rounded-xl relative overflow-hidden shadow-inner flex items-center justify-center">
                            <!-- Canvas Layer -->
                            <canvas id="artCanvas" class="bg-white shadow-2xl rounded-sm cursor-crosshair"></canvas>
                            <!-- è¦†ç›–å±‚ç”¨äºç»˜åˆ¶æ ‡æ³¨ -->
                            <canvas id="overlayCanvas" class="absolute shadow-2xl rounded-sm cursor-crosshair" style="pointer-events: auto;"></canvas>
                            
                            <!-- Help Toast -->
                            <div id="help-toast" class="absolute top-4 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-sm text-sm text-stone-600 pointer-events-none transition-all duration-300">
                                <i class="fa-solid fa-hand-pointer mr-2"></i> åœ¨ç”»æ¿ä¸Šç»˜åˆ¶ä»¥æ ‡è®°ä¿®æ”¹æ„è§
                            </div>
                            
                            <!-- åŒºåŸŸæ ‡æ³¨æç¤º -->
                            <div id="region-info" class="hidden absolute bottom-4 left-4 bg-purple-600/90 backdrop-blur px-4 py-2 rounded-lg shadow-lg text-sm text-white">
                                <i class="fa-solid fa-info-circle mr-2"></i> <span id="region-info-text">æ‹–æ‹½ç»˜åˆ¶åŒºåŸŸï¼Œæ¾å¼€åè¾“å…¥æè¿°</span>
                            </div>
                        </div>
                        
                        <!-- æ–‡å­—è¾“å…¥å¼¹çª— - ç§»åˆ°å®¹å™¨å¤–éƒ¨ä½¿ç”¨fixedå®šä½ -->
                        <div id="text-input-modal" class="hidden fixed bg-white rounded-lg shadow-2xl p-4 border border-stone-300" style="min-width: 300px; z-index: 9999; display: none;">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-bold text-stone-700"><i class="fa-solid fa-font mr-2 text-emerald-600"></i>æ·»åŠ æ–‡å­—æ ‡æ³¨</span>
                                <button onclick="app.cancelTextInput()" class="text-stone-400 hover:text-stone-600 p-1"><i class="fa-solid fa-times"></i></button>
                            </div>
                            <textarea id="annotation-text" rows="3" class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="è¾“å…¥ä¿®æ”¹æ„è§æˆ–æè¿°..."></textarea>
                            <div class="flex justify-end space-x-2 mt-3">
                                <button onclick="app.cancelTextInput()" class="px-4 py-2 text-sm text-stone-600 hover:bg-stone-100 rounded transition">å–æ¶ˆ</button>
                                <button onclick="app.confirmTextAnnotation()" class="px-5 py-2 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700 transition">ç¡®è®¤</button>
                            </div>
                        </div>
                    </div>
                `;

                setTimeout(app.initCanvas, 100);
            },

            setTool: (tool) => {
                appState.drawMode = tool;
                const tools = ['brush', 'eraser', 'text', 'region'];
                tools.forEach(t => {
                    const el = document.getElementById(`tool-${t}`);
                    if (el) {
                        el.className = tool === t 
                            ? "w-full text-left px-3 py-2 rounded bg-emerald-100 text-emerald-800 transition" 
                            : "w-full text-left px-3 py-2 rounded hover:bg-stone-100 text-stone-600 transition";
                    }
                });
                
                // æ›´æ–°å¸®åŠ©æç¤º
                const helpToast = document.getElementById('help-toast');
                const regionInfo = document.getElementById('region-info');
                if (helpToast) {
                    const tips = {
                        brush: 'åœ¨ç”»æ¿ä¸Šç»˜åˆ¶ä»¥æ ‡è®°ä¿®æ”¹æ„è§',
                        eraser: 'æ‹–æ‹½æ“¦é™¤ä¸éœ€è¦çš„æ ‡è®°',
                        text: 'ç‚¹å‡»ç”»æ¿ä»»æ„ä½ç½®æ·»åŠ æ–‡å­—æ ‡æ³¨',
                        region: 'è‡ªç”±ç»˜åˆ¶å°é—­åŒºåŸŸï¼Œæ¾å¼€åè¾“å…¥æè¿°è¿›è¡ŒAIé‡ç»˜'
                    };
                    helpToast.innerHTML = `<i class="fa-solid fa-hand-pointer mr-2"></i> ${tips[tool] || tips.brush}`;
                }
                if (regionInfo) {
                    regionInfo.className = tool === 'region' ? 'absolute bottom-4 left-4 bg-purple-600/90 backdrop-blur px-4 py-2 rounded-lg shadow-lg text-sm text-white' : 'hidden';
                }
                
                // æ›´æ–°ç”»å¸ƒå…‰æ ‡
                const overlayCanvas = document.getElementById('overlayCanvas');
                if (overlayCanvas) {
                    const cursors = {
                        brush: 'crosshair',
                        eraser: 'cell',
                        text: 'text',
                        region: 'crosshair'
                    };
                    overlayCanvas.style.cursor = cursors[tool] || 'crosshair';
                }
            },
            
            setBrushColor: (color) => {
                appState.brushColor = color;
            },

            initCanvas: () => {
                const canvas = document.getElementById('artCanvas');
                const overlayCanvas = document.getElementById('overlayCanvas');
                const parent = canvas.parentElement;
                
                // Set Canvas Size (Landscape 4:3ish)
                const width = parent.clientWidth * 0.9;
                const height = parent.clientHeight * 0.9;
                
                canvas.width = width;
                canvas.height = height;
                overlayCanvas.width = width;
                overlayCanvas.height = height;
                
                // è®¾ç½®è¦†ç›–å±‚ä½ç½®
                overlayCanvas.style.width = canvas.style.width;
                overlayCanvas.style.height = canvas.style.height;
                
                appState.canvasCtx = canvas.getContext('2d');
                appState.overlayCtx = overlayCanvas.getContext('2d');
                
                app.redrawCanvas();
                app.redrawOverlay();

                // Event Listeners for Drawing on Overlay
                let isDrawing = false;
                let lastX = 0, lastY = 0;

                const getMousePos = (e) => {
                    const rect = overlayCanvas.getBoundingClientRect();
                    return {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                };

                const startDraw = (e) => {
                    const pos = getMousePos(e);
                    
                    if (appState.drawMode === 'text') {
                        // æ–‡å­—æ ‡æ³¨æ¨¡å¼ï¼šæ˜¾ç¤ºè¾“å…¥å¼¹çª—
                        app.showTextInput(pos.x, pos.y);
                        return;
                    }
                    
                    if (appState.drawMode === 'region') {
                        // åŒºåŸŸæ ‡æ³¨æ¨¡å¼ï¼šå¼€å§‹è‡ªç”±ç»˜åˆ¶è·¯å¾„
                        appState.currentRegionPath = [pos];
                        appState.regionStart = pos;
                    }
                    
                    isDrawing = true;
                    lastX = pos.x;
                    lastY = pos.y;
                };
                
                const endDraw = (e) => {
                    if (appState.drawMode === 'region' && appState.currentRegionPath.length > 5) {
                        // è‡ªåŠ¨é—­åˆè·¯å¾„å¹¶è®¡ç®—è¾¹ç•Œæ¡†
                        const path = appState.currentRegionPath;
                        const bounds = app.getPathBounds(path);
                        
                        if (bounds.width > 20 && bounds.height > 20) {
                            // ä¿å­˜åŒºåŸŸè·¯å¾„å¹¶æ˜¾ç¤ºæ–‡å­—è¾“å…¥
                            appState.pendingRegion = {
                                path: [...path],
                                ...bounds
                            };
                            app.showTextInput(bounds.x + bounds.width / 2, bounds.y + bounds.height / 2, true);
                        }
                        
                        appState.currentRegionPath = [];
                        appState.regionStart = null;
                    }
                    
                    isDrawing = false;
                    appState.overlayCtx.beginPath();
                };
                
                const draw = (e) => {
                    const pos = getMousePos(e);
                    
                    if (appState.drawMode === 'region' && appState.currentRegionPath.length > 0) {
                        // å®æ—¶ç»˜åˆ¶è‡ªç”±åŒºåŸŸè·¯å¾„
                        appState.currentRegionPath.push(pos);
                        app.redrawOverlay();
                        return;
                    }
                    
                    if (!isDrawing) return;
                    
                    const ctx = appState.overlayCtx;
                    
                    if (appState.drawMode === 'brush') {
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.strokeStyle = appState.brushColor;
                        ctx.globalCompositeOperation = 'source-over';
                        
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();
                        
                        appState.customPaths.push({x1: lastX, y1: lastY, x2: pos.x, y2: pos.y, color: appState.brushColor});
                    } else if (appState.drawMode === 'eraser') {
                        ctx.lineWidth = 20;
                        ctx.lineCap = 'round';
                        ctx.globalCompositeOperation = 'destination-out';
                        
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();
                        ctx.globalCompositeOperation = 'source-over';
                    }
                    
                    lastX = pos.x;
                    lastY = pos.y;
                };

                overlayCanvas.addEventListener('mousedown', startDraw);
                overlayCanvas.addEventListener('mouseup', endDraw);
                overlayCanvas.addEventListener('mouseleave', endDraw);
                overlayCanvas.addEventListener('mousemove', draw);
            },
            
            // æ˜¾ç¤ºæ–‡å­—è¾“å…¥å¼¹çª—
            showTextInput: (x, y, isRegion = false) => {
                const modal = document.getElementById('text-input-modal');
                const overlayCanvas = document.getElementById('overlayCanvas');
                const rect = overlayCanvas.getBoundingClientRect();
                
                appState.pendingTextPosition = { x, y, isRegion };
                
                // è®¡ç®—å¼¹çª—ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†å£
                const modalWidth = 320;
                const modalHeight = 180;
                let posX = rect.left + x;
                let posY = rect.top + y;
                
                // ç¡®ä¿å¼¹çª—ä¸è¶…å‡ºå³è¾¹ç•Œ
                if (posX + modalWidth > window.innerWidth) {
                    posX = window.innerWidth - modalWidth - 20;
                }
                // ç¡®ä¿å¼¹çª—ä¸è¶…å‡ºä¸‹è¾¹ç•Œ
                if (posY + modalHeight > window.innerHeight) {
                    posY = window.innerHeight - modalHeight - 20;
                }
                // ç¡®ä¿ä¸è¶…å‡ºå·¦è¾¹ç•Œå’Œä¸Šè¾¹ç•Œ
                posX = Math.max(20, posX);
                posY = Math.max(20, posY);
                
                modal.style.left = `${posX}px`;
                modal.style.top = `${posY}px`;
                modal.style.display = 'block';
                modal.className = 'fixed bg-white rounded-lg shadow-xl p-4 z-[9999] border border-stone-300';
                
                const titleEl = modal.querySelector('span');
                if (titleEl) {
                    titleEl.innerHTML = isRegion 
                        ? '<i class="fa-solid fa-vector-square mr-2 text-purple-600"></i>åŒºåŸŸæè¿° (AIå°†é‡ç»˜æ­¤åŒºåŸŸ)'
                        : '<i class="fa-solid fa-font mr-2 text-emerald-600"></i>æ·»åŠ æ–‡å­—æ ‡æ³¨';
                }
                
                document.getElementById('annotation-text').value = '';
                document.getElementById('annotation-text').focus();
            },
            
            cancelTextInput: () => {
                const modal = document.getElementById('text-input-modal');
                modal.style.display = 'none';
                modal.className = 'hidden fixed bg-white rounded-lg shadow-xl p-4 z-[9999] border border-stone-300';
                appState.pendingTextPosition = null;
                appState.pendingRegion = null;
                appState.currentRegionPath = [];
                app.redrawOverlay();
            },
            
            confirmTextAnnotation: () => {
                const text = document.getElementById('annotation-text').value.trim();
                if (!text) {
                    alert('è¯·è¾“å…¥æ ‡æ³¨å†…å®¹');
                    return;
                }
                
                const pos = appState.pendingTextPosition;
                
                if (pos.isRegion && appState.pendingRegion) {
                    // åŒºåŸŸæ ‡æ³¨ï¼ˆåŒ…å«è‡ªç”±ç»˜åˆ¶è·¯å¾„ï¼‰
                    appState.annotations.push({
                        type: 'region',
                        path: appState.pendingRegion.path || null,
                        x: appState.pendingRegion.x,
                        y: appState.pendingRegion.y,
                        width: appState.pendingRegion.width,
                        height: appState.pendingRegion.height,
                        content: text,
                        color: appState.brushColor
                    });
                    appState.pendingRegion = null;
                } else {
                    // æ–‡å­—æ ‡æ³¨
                    appState.annotations.push({
                        type: 'text',
                        x: pos.x,
                        y: pos.y,
                        content: text,
                        color: appState.brushColor
                    });
                }
                
                app.cancelTextInput();
                app.redrawOverlay();
            },
            
            // è®¡ç®—è·¯å¾„è¾¹ç•Œæ¡†
            getPathBounds: (path) => {
                if (!path || path.length === 0) return { x: 0, y: 0, width: 0, height: 0 };
                
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                path.forEach(p => {
                    minX = Math.min(minX, p.x);
                    minY = Math.min(minY, p.y);
                    maxX = Math.max(maxX, p.x);
                    maxY = Math.max(maxY, p.y);
                });
                
                return {
                    x: minX,
                    y: minY,
                    width: maxX - minX,
                    height: maxY - minY
                };
            },
            
            // é‡ç»˜è¦†ç›–å±‚
            redrawOverlay: () => {
                const ctx = appState.overlayCtx;
                const canvas = document.getElementById('overlayCanvas');
                if (!ctx || !canvas) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶æ‰€æœ‰ä¿å­˜çš„è·¯å¾„
                appState.customPaths.forEach(path => {
                    if (path.x1 !== undefined) {
                        ctx.beginPath();
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.strokeStyle = path.color || '#ef4444';
                        ctx.moveTo(path.x1, path.y1);
                        ctx.lineTo(path.x2, path.y2);
                        ctx.stroke();
                    }
                });
                
                // ç»˜åˆ¶æ‰€æœ‰æ ‡æ³¨
                appState.annotations.forEach((ann, index) => {
                    if (ann.type === 'text') {
                        app.drawTextAnnotation(ctx, ann, index);
                    } else if (ann.type === 'region') {
                        app.drawRegionAnnotation(ctx, ann, index);
                    }
                });
                
                // ç»˜åˆ¶å½“å‰æ­£åœ¨ç»˜åˆ¶çš„è‡ªç”±åŒºåŸŸè·¯å¾„
                if (appState.currentRegionPath.length > 1) {
                    ctx.beginPath();
                    ctx.strokeStyle = appState.brushColor;
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    ctx.moveTo(appState.currentRegionPath[0].x, appState.currentRegionPath[0].y);
                    for (let i = 1; i < appState.currentRegionPath.length; i++) {
                        ctx.lineTo(appState.currentRegionPath[i].x, appState.currentRegionPath[i].y);
                    }
                    ctx.stroke();
                    
                    // ç»˜åˆ¶åŠé€æ˜å¡«å……é¢„è§ˆ
                    ctx.fillStyle = `${appState.brushColor}22`;
                    ctx.fill();
                    
                    // æ˜¾ç¤ºå°ºå¯¸
                    const bounds = app.getPathBounds(appState.currentRegionPath);
                    if (bounds.width > 10 && bounds.height > 10) {
                        const sizeText = `${Math.round(bounds.width)} Ã— ${Math.round(bounds.height)}`;
                        ctx.font = '12px sans-serif';
                        ctx.fillStyle = appState.brushColor;
                        ctx.fillText(sizeText, bounds.x, bounds.y - 5);
                    }
                }
            },
            
            // ç»˜åˆ¶æ–‡å­—æ ‡æ³¨
            drawTextAnnotation: (ctx, ann, index) => {
                const padding = 8;
                ctx.font = '14px "Noto Sans SC", sans-serif';
                const textWidth = ctx.measureText(ann.content).width;
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.strokeStyle = ann.color || '#ef4444';
                ctx.lineWidth = 2;
                
                const boxX = ann.x;
                const boxY = ann.y - 10;
                const boxWidth = textWidth + padding * 2;
                const boxHeight = 28;
                
                // åœ†è§’çŸ©å½¢
                ctx.beginPath();
                ctx.roundRect(boxX, boxY, boxWidth, boxHeight, 6);
                ctx.fill();
                ctx.stroke();
                
                // ç»˜åˆ¶å°ä¸‰è§’æŒ‡ç¤ºå™¨
                ctx.fillStyle = ann.color || '#ef4444';
                ctx.beginPath();
                ctx.moveTo(boxX + 10, boxY + boxHeight);
                ctx.lineTo(boxX + 15, boxY + boxHeight + 8);
                ctx.lineTo(boxX + 20, boxY + boxHeight);
                ctx.closePath();
                ctx.fill();
                
                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = '#333';
                ctx.fillText(ann.content, boxX + padding, boxY + 19);
                
                // ç»˜åˆ¶åºå·
                ctx.fillStyle = ann.color || '#ef4444';
                ctx.font = 'bold 10px sans-serif';
                ctx.beginPath();
                ctx.arc(boxX - 5, boxY - 5, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.fillText(String(index + 1), boxX - 8, boxY - 2);
            },
            
            // ç»˜åˆ¶åŒºåŸŸæ ‡æ³¨
            drawRegionAnnotation: (ctx, ann, index) => {
                // å¦‚æœæœ‰è‡ªç”±è·¯å¾„ï¼Œç»˜åˆ¶è‡ªç”±å½¢çŠ¶
                if (ann.path && ann.path.length > 2) {
                    ctx.beginPath();
                    ctx.moveTo(ann.path[0].x, ann.path[0].y);
                    for (let i = 1; i < ann.path.length; i++) {
                        ctx.lineTo(ann.path[i].x, ann.path[i].y);
                    }
                    ctx.closePath();
                    
                    // ç»˜åˆ¶åŠé€æ˜åŒºåŸŸ
                    ctx.fillStyle = `${ann.color || '#ef4444'}22`;
                    ctx.fill();
                    
                    // ç»˜åˆ¶è¾¹æ¡†
                    ctx.strokeStyle = ann.color || '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([8, 4]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                } else {
                    // å…¼å®¹æ—§çš„çŸ©å½¢åŒºåŸŸ
                    ctx.fillStyle = `${ann.color || '#ef4444'}22`;
                    ctx.fillRect(ann.x, ann.y, ann.width, ann.height);
                    
                    ctx.strokeStyle = ann.color || '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([8, 4]);
                    ctx.strokeRect(ann.x, ann.y, ann.width, ann.height);
                    ctx.setLineDash([]);
                }
                
                // ç»˜åˆ¶æ ‡ç­¾
                const labelText = ann.content.length > 30 ? ann.content.substring(0, 30) + '...' : ann.content;
                ctx.font = '12px "Noto Sans SC", sans-serif';
                const textWidth = ctx.measureText(labelText).width;
                
                const labelX = ann.x;
                const labelY = ann.y - 5;
                const labelHeight = 22;
                const labelWidth = textWidth + 30;
                
                // æ ‡ç­¾èƒŒæ™¯
                ctx.fillStyle = ann.color || '#ef4444';
                ctx.beginPath();
                ctx.roundRect(labelX, labelY - labelHeight, labelWidth, labelHeight, 4);
                ctx.fill();
                
                // åºå·
                ctx.fillStyle = 'white';
                ctx.font = 'bold 11px sans-serif';
                ctx.fillText(`#${index + 1}`, labelX + 6, labelY - 7);
                
                // æ–‡å­—
                ctx.font = '12px "Noto Sans SC", sans-serif';
                ctx.fillText(labelText, labelX + 25, labelY - 7);
                
                // å°ºå¯¸ä¿¡æ¯
                const sizeText = `${Math.round(ann.width)} Ã— ${Math.round(ann.height)}`;
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.font = '10px sans-serif';
                ctx.fillText(sizeText, ann.x + ann.width - ctx.measureText(sizeText).width - 5, ann.y + ann.height - 5);
            },
            
            // æ’¤é”€ä¸Šä¸€æ­¥
            undoLastAnnotation: () => {
                if (appState.annotations.length > 0) {
                    appState.annotations.pop();
                    app.redrawOverlay();
                } else if (appState.customPaths.length > 0) {
                    // ç§»é™¤æœ€å10ä¸ªè·¯å¾„ç‚¹
                    appState.customPaths = appState.customPaths.slice(0, -10);
                    app.redrawOverlay();
                }
            },
            
            // AIå›¾ç”Ÿå›¾ï¼šåŒºåŸŸé‡ç»˜
            generateInpaint: async () => {
                const regionAnnotations = appState.annotations.filter(a => a.type === 'region');
                
                if (regionAnnotations.length === 0) {
                    alert('è¯·å…ˆä½¿ç”¨ã€Œæ¡†é€‰åŒºåŸŸã€å·¥å…·æ ‡è®°éœ€è¦é‡ç»˜çš„åŒºåŸŸï¼Œå¹¶æ·»åŠ æè¿°');
                    return;
                }
                
                const btn = document.getElementById('btn-inpaint');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> AI ç”Ÿæˆä¸­...';
                btn.disabled = true;
                appState.isGeneratingInpaint = true;
                
                try {
                    const imageUrl = await app.callInpaintAPI(regionAnnotations);
                    appState.generatedImageUrl = imageUrl;
                    appState.annotations = []; // æ¸…é™¤å·²å¤„ç†çš„æ ‡æ³¨
                    appState.customPaths = [];
                    app.redrawCanvas();
                    app.redrawOverlay();
                    
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> åŒºåŸŸé‡ç»˜';
                    btn.disabled = false;
                } catch (error) {
                    console.error('å›¾ç”Ÿå›¾å¤±è´¥:', error);
                    btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-2"></i> ç”Ÿæˆå¤±è´¥';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> åŒºåŸŸé‡ç»˜';
                        btn.disabled = false;
                    }, 2000);
                    alert('å›¾ç”Ÿå›¾å¤±è´¥: ' + error.message);
                }
                
                appState.isGeneratingInpaint = false;
            },
            
            // è°ƒç”¨å›¾ç”Ÿå›¾API
            callInpaintAPI: async (regions) => {
                const API_KEY = 'sk-d7leMiEV2bAHJ44cRfWP5sVJ4pQc250cS8mPRzpNTDF3A0ou';
                
                // æ„å»ºåŒ…å«åŒºåŸŸæè¿°çš„prompt
                const regionDescriptions = regions.map((r, i) => 
                    `åŒºåŸŸ${i + 1} (ä½ç½®: ${Math.round(r.x)},${Math.round(r.y)}, å°ºå¯¸: ${Math.round(r.width)}x${Math.round(r.height)}): ${r.content}`
                ).join('; ');
                
                const basePrompt = app.buildPrompt(appState.selectedStyle);
                const editPrompt = `${basePrompt}. æ ¹æ®ä»¥ä¸‹ä¿®æ”¹æ„è§è°ƒæ•´å›¾åƒ: ${regionDescriptions}. ä¿æŒæ•´ä½“é£æ ¼ä¸€è‡´ï¼Œä»…ä¿®æ”¹æŒ‡å®šåŒºåŸŸã€‚`;
                
                // å¦‚æœæœ‰ç°æœ‰å›¾ç‰‡ï¼Œè¿›è¡Œå›¾ç”Ÿå›¾
                let requestBody = {
                    contents: [{
                        parts: [{
                            text: editPrompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 8192
                    }
                };
                
                // å¦‚æœæœ‰ç°æœ‰å›¾ç‰‡ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (appState.generatedImageUrl && appState.generatedImageUrl.startsWith('data:')) {
                    const base64Data = appState.generatedImageUrl.split(',')[1];
                    const mimeType = appState.generatedImageUrl.split(';')[0].split(':')[1];
                    
                    requestBody.contents[0].parts.unshift({
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Data
                        }
                    });
                    requestBody.contents[0].parts[1].text = `åŸºäºè¿™å¼ å›¾ç‰‡ï¼Œ${editPrompt}`;
                }
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 90000);
                
                const response = await fetch('https://api.vectorengine.ai/v1beta/models/gemini-3-pro-image-preview:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error?.message || `HTTP ${response.status}`);
                }
                
                // è§£æè¿”å›çš„å›¾ç‰‡
                if (result.candidates && result.candidates[0]?.content?.parts) {
                    for (const part of result.candidates[0].content.parts) {
                        if (part.inlineData?.data) {
                            return `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;
                        }
                        if (part.inline_data?.data) {
                            return `data:${part.inline_data.mime_type || 'image/png'};base64,${part.inline_data.data}`;
                        }
                    }
                }
                
                throw new Error('å“åº”ä¸­æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®');
            },
            
            // æ ¹æ®æ ‡æ³¨é‡æ–°ç”Ÿæˆï¼ˆå›¾ç”Ÿå›¾æ¨¡å¼ï¼‰
            regenerateWithAnnotations: async () => {
                const allAnnotations = appState.annotations;
                
                if (allAnnotations.length === 0) {
                    // æ²¡æœ‰æ ‡æ³¨ï¼Œç›´æ¥é‡æ–°ç”Ÿæˆ
                    app.redrawCanvas();
                    return;
                }
                
                // æœ‰æ ‡æ³¨ï¼Œè°ƒç”¨APIè¿›è¡Œå›¾ç”Ÿå›¾
                const btn = document.querySelector('button[onclick="app.regenerateWithAnnotations()"]');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-1"></i> AI ç¼–è¾‘ä¸­...';
                btn.disabled = true;
                
                try {
                    const API_KEY = 'sk-d7leMiEV2bAHJ44cRfWP5sVJ4pQc250cS8mPRzpNTDF3A0ou';
                    
                    // æ„å»ºåŒ…å«æ‰€æœ‰æ ‡æ³¨çš„prompt
                    const annotationDesc = allAnnotations.map((a, i) => {
                        if (a.type === 'text') {
                            return `ä¿®æ”¹æ„è§${i + 1}: ${a.content}`;
                        } else {
                            return `åŒºåŸŸä¿®æ”¹${i + 1} (ä½ç½®: ${Math.round(a.x)},${Math.round(a.y)}, å°ºå¯¸: ${Math.round(a.width)}x${Math.round(a.height)}): ${a.content}`;
                        }
                    }).join('; ');
                    
                    const basePrompt = app.buildPrompt(appState.selectedStyle);
                    const editPrompt = `${basePrompt}. æ ¹æ®ä»¥ä¸‹ä¿®æ”¹æ„è§è°ƒæ•´å›¾åƒ: ${annotationDesc}. ä¿æŒæ•´ä½“æ„å›¾å’Œé£æ ¼ï¼Œä»…æŒ‰è¦æ±‚è¿›è¡Œå±€éƒ¨ä¿®æ”¹ã€‚`;
                    
                    // æ„å»ºè¯·æ±‚ä½“
                    let requestBody = {
                        contents: [{
                            parts: [{
                                text: editPrompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192
                        }
                    };
                    
                    // å¦‚æœæœ‰ç°æœ‰å›¾ç‰‡ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­è¿›è¡Œå›¾ç”Ÿå›¾
                    if (appState.generatedImageUrl && appState.generatedImageUrl.startsWith('data:')) {
                        const base64Data = appState.generatedImageUrl.split(',')[1];
                        const mimeType = appState.generatedImageUrl.split(';')[0].split(':')[1];
                        
                        requestBody.contents[0].parts.unshift({
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Data
                            }
                        });
                        requestBody.contents[0].parts[1].text = `åŸºäºè¿™å¼ å›¾ç‰‡ï¼Œ${editPrompt}`;
                        
                        console.log('ä½¿ç”¨å›¾ç”Ÿå›¾æ¨¡å¼ï¼šå°†ç°æœ‰å›¾ç‰‡å’Œç¼–è¾‘æŒ‡ä»¤ä¸€èµ·å‘é€');
                    } else {
                        console.log('ä½¿ç”¨çº¯æ–‡æœ¬ç”Ÿæˆæ¨¡å¼ï¼šæ²¡æœ‰ç°æœ‰å›¾ç‰‡');
                    }
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 90000);
                    
                    const response = await fetch('https://api.vectorengine.ai/v1beta/models/gemini-3-pro-image-preview:generateContent', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error?.message || `HTTP ${response.status}`);
                    }
                    
                    // è§£æè¿”å›çš„å›¾ç‰‡
                    let newImageUrl = null;
                    if (result.candidates && result.candidates[0]?.content?.parts) {
                        for (const part of result.candidates[0].content.parts) {
                            if (part.inlineData?.data) {
                                newImageUrl = `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;
                                break;
                            }
                            if (part.inline_data?.data) {
                                newImageUrl = `data:${part.inline_data.mime_type || 'image/png'};base64,${part.inline_data.data}`;
                                break;
                            }
                        }
                    }
                    
                    if (!newImageUrl) {
                        throw new Error('å“åº”ä¸­æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®');
                    }
                    
                    appState.generatedImageUrl = newImageUrl;
                    appState.annotations = [];
                    appState.customPaths = [];
                    app.redrawCanvas();
                    app.redrawOverlay();
                    
                    btn.innerHTML = '<i class="fa-solid fa-rotate mr-1"></i> é‡æ–°ç”Ÿæˆ';
                    btn.disabled = false;
                } catch (error) {
                    console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                    btn.innerHTML = '<i class="fa-solid fa-rotate mr-1"></i> é‡æ–°ç”Ÿæˆ';
                    btn.disabled = false;
                    alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
                }
            },

            redrawCanvas: () => {
                const ctx = appState.canvasCtx;
                const canvas = document.getElementById('artCanvas');
                if (!ctx || !canvas) return;

                // Clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = 'source-over';

                // å¦‚æœæœ‰ API ç”Ÿæˆçš„å›¾ç‰‡ï¼Œç›´æ¥æ˜¾ç¤º
                if (appState.generatedImageUrl) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous'; // å¤„ç†è·¨åŸŸ
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.onerror = () => {
                        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                        app.drawPlaceholder(ctx, canvas); // åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½å›¾
                    };
                    img.src = appState.generatedImageUrl;
                    return;
                }

                // å¦åˆ™ä½¿ç”¨é»˜è®¤çš„ç¨‹åºç”Ÿæˆæ–¹æ¡ˆ
                app.drawPlaceholder(ctx, canvas);
            },

            drawPlaceholder: (ctx, canvas) => {
                // 1. Draw Background (Based on Style)
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                if (appState.selectedStyle.id === 'zen') {
                    grad.addColorStop(0, '#e0e0e0');
                    grad.addColorStop(1, '#bdbdbd');
                } else {
                    grad.addColorStop(0, '#2d3436');
                    grad.addColorStop(1, '#1e272e');
                }
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 2. Procedural Moss Generation (Circles for demo)
                // Seed random based on style
                const elements = 20;
                for(let i=0; i<elements; i++) {
                    ctx.beginPath();
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const r = Math.random() * 50 + 20;
                    
                    ctx.arc(x, y, r, 0, Math.PI * 2);
                    
                    // Style specific colors
                    if (appState.selectedStyle.id === 'forest') {
                        ctx.fillStyle = Math.random() > 0.5 ? '#2e7d32' : '#1b5e20';
                    } else if (appState.selectedStyle.id === 'zen') {
                        ctx.fillStyle = Math.random() > 0.7 ? '#4a7c59' : '#9e9e9e'; // Moss patches on stone
                    } else {
                        ctx.fillStyle = '#26a69a'; // Geometric
                    }
                    ctx.fill();
                }

                // 3. Draw Added Materials (Icon representation)
                appState.selectedMaterials.forEach(mat => {
                    // Random placement for materials
                    ctx.font = '30px FontAwesome';
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    const x = Math.random() * canvas.width * 0.8 + 50;
                    const y = Math.random() * canvas.height * 0.8 + 50;
                    // Note: Canvas text rendering for icons works if font loaded, otherwise might show box
                    // For robustness in this demo, we draw simple shapes
                    ctx.beginPath();
                    ctx.rect(x, y, 20, 20);
                    ctx.fillStyle = '#d4ac0d'; // Gold accent
                    ctx.fill();
                });
            },

            clearGraffiti: () => {
                appState.customPaths = [];
                appState.annotations = [];
                appState.currentRegion = null;
                appState.regionStart = null;
                appState.currentRegionPath = [];
                app.redrawCanvas();
                app.redrawOverlay();
            },

            // --- ä¸‹è½½3Dæ¨¡å‹ï¼ˆè§£å†³è·¨åŸŸé—®é¢˜ï¼‰---
            downloadModel: async (url, filename) => {
                try {
                    console.log('å¼€å§‹ä¸‹è½½æ¨¡å‹ï¼ŒåŸå§‹URL:', url);
                    
                    // æ˜¾ç¤ºä¸‹è½½æç¤º
                    const statusDiv = document.getElementById('tripo-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<p class="text-blue-600"><i class="fa-solid fa-download mr-2"></i>æ­£åœ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶...</p>';
                    }

                    // æ–¹æ¡ˆ1: å°è¯•ç›´æ¥ä¸‹è½½ï¼ˆæŸäº›æµè§ˆå™¨å¯èƒ½å…è®¸ï¼‰
                    try {
                        const response = await fetch(url, { mode: 'cors' });
                        if (response.ok) {
                            const blob = await response.blob();
                            const blobUrl = window.URL.createObjectURL(blob);
                            
                            const a = document.createElement('a');
                            a.href = blobUrl;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            
                            setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);
                            
                            if (statusDiv) {
                                statusDiv.innerHTML = '<p class="text-green-600 mb-4"><i class="fa-solid fa-check-circle mr-2"></i>3Dæ¨¡å‹ç”ŸæˆæˆåŠŸï¼ä¸‹è½½å·²å®Œæˆï¼</p>' + statusDiv.innerHTML.split('</p>').slice(1).join('</p>');
                            }
                            
                            console.log('âœ“ æ¨¡å‹æ–‡ä»¶å·²ä¸‹è½½åˆ°:', filename);
                            return;
                        }
                    } catch (corsError) {
                        console.log('ç›´æ¥ä¸‹è½½å¤±è´¥ï¼ˆCORSé™åˆ¶ï¼‰ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
                    }
                    
                    // æ–¹æ¡ˆ2: ä½¿ç”¨éšè—iframeè§¦å‘ä¸‹è½½ï¼ˆé€‚ç”¨äºä¸€äº›CDNï¼‰
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = url;
                    document.body.appendChild(iframe);
                    
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        if (statusDiv) {
                            statusDiv.innerHTML = '<p class="text-green-600 mb-4"><i class="fa-solid fa-check-circle mr-2"></i>3Dæ¨¡å‹ç”ŸæˆæˆåŠŸï¼å·²è§¦å‘ä¸‹è½½ï¼ˆè‹¥æœªå¼€å§‹ï¼Œè¯·ç‚¹å‡»"ç›´æ¥è®¿é—®"ï¼‰</p>' + statusDiv.innerHTML.split('</p>').slice(1).join('</p>');
                        }
                    }, 3000);
                    
                    console.log('âœ“ å·²è§¦å‘ä¸‹è½½ï¼ŒåŸå§‹URL:', url);
                    
                } catch (error) {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    alert('ä¸‹è½½é‡åˆ°é—®é¢˜ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å¤‡ç”¨æ–¹æ¡ˆï¼š\n\n' +
                          '1. ç‚¹å‡»ä¸‹æ–¹"ç›´æ¥è®¿é—®"æŒ‰é’®\n' +
                          '2. åœ¨æ–°æ‰“å¼€çš„é¡µé¢å³é”®é€‰æ‹©"å¦å­˜ä¸º"\n' +
                          '3. æˆ–ç›´æ¥å¤åˆ¶é“¾æ¥åˆ°æµè§ˆå™¨åœ°å€æ ä¸‹è½½\n\n' +
                          'æ¨¡å‹URLå·²å¤åˆ¶åˆ°æ§åˆ¶å°ï¼ˆæŒ‰F12æŸ¥çœ‹ï¼‰');
                    console.log('æ¨¡å‹ä¸‹è½½URL:', url);
                }
            },

            // --- Tripo AI 2Dè½¬3DåŠŸèƒ½ ---
            generateTripo3D: async (imageDataUrl) => {
                const statusDiv = document.getElementById('tripo-status');
                const btn = document.getElementById('generate3d-btn');
                
                try {
                    if (!imageDataUrl) {
                        throw new Error('è¯·å…ˆç”Ÿæˆ2Dè®¾è®¡å›¾');
                    }

                    appState.is3DGenerating = true;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...';
                    statusDiv.innerHTML = '<p class="text-blue-600"><i class="fa-solid fa-clock mr-2"></i>æ­¥éª¤1/3: ä¸Šä¼ å›¾ç‰‡åˆ°Tripo AI...</p>';

                    // å°†base64è½¬æ¢ä¸ºblob
                    const blob = await fetch(imageDataUrl).then(r => r.blob());
                    
                    // 1. ä¸Šä¼ å›¾ç‰‡
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', blob, 'design.png');
                    
                    const uploadResponse = await fetch(`${TRIPO_CONFIG.baseUrl}/upload`, {
                        method: 'POST',
                        body: uploadFormData
                    });

                    if (!uploadResponse.ok) {
                        const error = await uploadResponse.json();
                        throw new Error(`ä¸Šä¼ å¤±è´¥: ${error.message || uploadResponse.statusText}`);
                    }

                    const uploadData = await uploadResponse.json();
                    const imageToken = uploadData.data.image_token;
                    
                    statusDiv.innerHTML = '<p class="text-blue-600"><i class="fa-solid fa-clock mr-2"></i>æ­¥éª¤2/3: ç”Ÿæˆ3Dæ¨¡å‹ä¸­ï¼ˆçº¦éœ€1-2åˆ†é’Ÿï¼‰...</p>';

                    // 2. åˆ›å»º3Dä»»åŠ¡
                    const taskResponse = await fetch(`${TRIPO_CONFIG.baseUrl}/task`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type: 'image_to_model',
                            file: { type: 'png', file_token: imageToken },
                            // ğŸ‘‡ è¿™æ˜¯ç»™Tripo AIçš„æç¤ºè¯ï¼Œå¯ä»¥åœ¨TRIPO_CONFIGä¸­ä¿®æ”¹
                            prompt: TRIPO_CONFIG.defaultPrompt,
                            ...TRIPO_CONFIG.modelParams
                        })
                    });

                    if (!taskResponse.ok) {
                        const error = await taskResponse.json();
                        throw new Error(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${error.message || taskResponse.statusText}`);
                    }

                    const taskData = await taskResponse.json();
                    const taskId = taskData.data.task_id;

                    // 3. è½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                    let attempts = 0;
                    const maxAttempts = 60; // æœ€å¤šç­‰å¾…5åˆ†é’Ÿ
                    
                    const checkStatus = async () => {
                        const statusResponse = await fetch(`${TRIPO_CONFIG.baseUrl}/task/${taskId}`);

                        const statusData = await statusResponse.json();
                        console.log('ğŸ“Š å®Œæ•´çŠ¶æ€æ•°æ®:', JSON.stringify(statusData, null, 2));
                        
                        const status = statusData.data?.status;

                        if (status === 'success') {
                            // ç”ŸæˆæˆåŠŸ
                            appState.generated3DModel = statusData.data.output;
                            
                            // è¯¦ç»†æ£€æŸ¥è¾“å‡ºæ•°æ®
                            console.log('âœ“ 3Dæ¨¡å‹ç”ŸæˆæˆåŠŸï¼');
                            console.log('ğŸ“¦ è¾“å‡ºæ•°æ®ç»“æ„:', statusData.data.output);
                            
                            // å…¼å®¹å¤šç§å¯èƒ½çš„å­—æ®µå
                            const modelUrl = statusData.data.output?.pbr_model?.model_url 
                                          || statusData.data.output?.pbr_model 
                                          || statusData.data.output?.model 
                                          || statusData.data.output?.glb;
                            
                            const renderUrl = statusData.data.output?.rendered_image?.url
                                           || statusData.data.output?.rendered_image
                                           || statusData.data.output?.preview;
                            
                            console.log('  GLBæ¨¡å‹URL:', modelUrl);
                            console.log('  æ¸²æŸ“é¢„è§ˆå›¾:', renderUrl);
                            
                            if (!modelUrl) {
                                console.error('âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°æ¨¡å‹URLï¼å®Œæ•´æ•°æ®:', JSON.stringify(statusData.data.output, null, 2));
                                throw new Error('APIè¿”å›æˆåŠŸä½†æœªæ‰¾åˆ°æ¨¡å‹ä¸‹è½½é“¾æ¥');
                            }
                            
                            statusDiv.innerHTML = `
                                <p class="text-green-600 mb-4"><i class="fa-solid fa-check-circle mr-2"></i>3Dæ¨¡å‹ç”ŸæˆæˆåŠŸï¼</p>
                                <div class="flex gap-2 justify-center flex-wrap mb-3">
                                    ${modelUrl ? `
                                    <button onclick="app.downloadModel('${modelUrl}', 'taijing_3d_model.glb')" 
                                       class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition shadow-md">
                                        <i class="fa-solid fa-download mr-2"></i>ä¸‹è½½GLBæ¨¡å‹
                                    </button>
                                    <a href="${modelUrl}" target="_blank" download="taijing_3d_model.glb"
                                       class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition inline-flex items-center shadow-md">
                                        <i class="fa-solid fa-external-link mr-2"></i>å¤‡ç”¨ä¸‹è½½
                                    </a>
                                    ` : '<p class="text-red-500">æ¨¡å‹URLæœªæ‰¾åˆ°</p>'}
                                    ${renderUrl ? `
                                    <button onclick="window.open('${renderUrl}', '_blank')" 
                                       class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md">
                                        <i class="fa-solid fa-image mr-2"></i>æŸ¥çœ‹æ¸²æŸ“å›¾
                                    </button>
                                    ` : ''}
                                </div>
                                <div class="bg-stone-50 rounded-lg p-3 text-left text-xs">
                                    <p class="text-stone-600 mb-2"><strong>ğŸ“¥ ä¸‹è½½è¯´æ˜ï¼š</strong></p>
                                    <ul class="text-stone-500 space-y-1 ml-4">
                                        <li>â€¢ <strong>ä¸‹è½½GLBæ¨¡å‹</strong>ï¼šè‡ªåŠ¨è§¦å‘æµè§ˆå™¨ä¸‹è½½</li>
                                        <li>â€¢ <strong>å¤‡ç”¨ä¸‹è½½</strong>ï¼šå¦‚æœè‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œç‚¹å‡»æ­¤æŒ‰é’®åå³é”®"å¦å­˜ä¸º"</li>
                                        <li>â€¢ æ–‡ä»¶ä¿å­˜ä½ç½®ï¼š<code class="bg-white px-1 rounded">C:\\Users\\ä½ çš„ç”¨æˆ·å\\Downloads\\taijing_3d_model.glb</code></li>
                                        ${!modelUrl ? '<li class="text-red-500">âš ï¸ æ¨¡å‹URLæœªæ‰¾åˆ°ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ï¼ˆF12ï¼‰è·å–è¯¦ç»†ä¿¡æ¯</li>' : ''}
                                    </ul>
                                    ${modelUrl ? `<p class="text-stone-400 mt-2 text-[10px]">ğŸ’¡ æ¨¡å‹URL: <span class="break-all">${modelUrl}</span></p>` : ''}
                                </div>
                            `;
                            btn.innerHTML = '<i class="fa-solid fa-cube mr-2"></i>é‡æ–°ç”Ÿæˆ3D';
                            btn.disabled = false;
                            appState.is3DGenerating = false;
                        } else if (status === 'failed') {
                            throw new Error('3Dæ¨¡å‹ç”Ÿæˆå¤±è´¥');
                        } else {
                            // ç»§ç»­ç­‰å¾…
                            attempts++;
                            if (attempts >= maxAttempts) {
                                throw new Error('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•');
                            }
                            statusDiv.innerHTML = `<p class="text-blue-600"><i class="fa-solid fa-clock mr-2"></i>æ­¥éª¤3/3: å¤„ç†ä¸­... (${attempts * 5}ç§’)</p>`;
                            setTimeout(checkStatus, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                        }
                    };

                    await checkStatus();

                } catch (error) {
                    console.error('3Dç”Ÿæˆå¤±è´¥:', error);
                    statusDiv.innerHTML = `<p class="text-red-600"><i class="fa-solid fa-exclamation-circle mr-2"></i>ç”Ÿæˆå¤±è´¥: ${error.message}</p>`;
                    btn.innerHTML = '<i class="fa-solid fa-cube mr-2"></i>ç”Ÿæˆ3Dæ¨¡å‹';
                    btn.disabled = false;
                    appState.is3DGenerating = false;
                }
            },

            // --- VIEW 4: Export ---
            renderStep4: () => {
                const container = document.getElementById('app-container');
                container.innerHTML = `
                    <div class="max-w-3xl mx-auto animate-fade-in text-center pt-10">
                        <div class="inline-block p-6 rounded-full bg-emerald-100 text-emerald-800 mb-6 text-4xl">
                            <i class="fa-solid fa-cube"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-4 serif">è®¾è®¡å®šç¨¿å·²ç¡®è®¤</h2>
                        <p class="text-stone-500 mb-8">æ‚¨çš„ä¸“å±â€œ${appState.selectedStyle.name}â€æ–¹æ¡ˆå·²ç”Ÿæˆã€‚æ­£åœ¨è½¬æ¢ä¸ºå·¥ç¨‹å›¾çº¸å’Œ3Dé¢„è§ˆæ¨¡å‹ã€‚</p>

                        <div class="bg-white p-8 rounded-2xl shadow-lg text-left border border-stone-100 mb-8 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500 animate-pulse"></div>
                            <h3 class="font-bold text-lg mb-4">è®¢å•æ˜ç»†</h3>
                            <ul class="space-y-3 text-sm text-stone-600">
                                <li class="flex justify-between border-b border-stone-100 pb-2">
                                    <span>è®¾è®¡é£æ ¼</span>
                                    <span class="font-bold">${appState.selectedStyle.name}</span>
                                </li>
                                <li class="flex justify-between border-b border-stone-100 pb-2">
                                    <span>åŒ…å«ç´ æ</span>
                                    <span class="text-right">
                                        ${Array.from(appState.selectedMaterials).map(m => {
                                            const item = [...MATERIALS_DB.base, ...MATERIALS_DB.decor].find(x => x.id === m);
                                            return item ? item.name : m;
                                        }).join(', ') || 'æ ‡å‡†é…ç½®'}
                                    </span>
                                </li>
                                <li class="flex justify-between pt-2">
                                    <span>å·¥ç¨‹æ–‡ä»¶æ ¼å¼</span>
                                    <span>.OBJ / .CAD / .PDF</span>
                                </li>
                            </ul>
                        </div>

                        <!-- 3Dç”ŸæˆåŒºåŸŸ -->
                        <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-2xl shadow-lg mb-6 border border-blue-200">
                            <h3 class="font-bold text-lg mb-2 flex items-center">
                                <i class="fa-solid fa-cube mr-2 text-blue-600"></i>
                                AI 3Dæ¨¡å‹ç”Ÿæˆ (Powered by Tripo AI)
                            </h3>
                            <p class="text-sm text-stone-600 mb-4">å°†ä½ çš„2Dè®¾è®¡å›¾è½¬æ¢ä¸ºå¯ç”¨äº3Dæ‰“å°çš„æ¨¡å‹æ–‡ä»¶</p>
                            <div id="tripo-status" class="mb-4 min-h-[50px] flex items-center justify-center">
                                <p class="text-stone-400">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ç”Ÿæˆ3Dæ¨¡å‹</p>
                            </div>
                            <button id="generate3d-btn" onclick="app.generateTripo3D(appState.generatedImageUrl)" 
                                    class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg shadow-lg hover:shadow-xl transition transform hover:scale-105">
                                <i class="fa-solid fa-cube mr-2"></i>ç”Ÿæˆ3Dæ¨¡å‹
                            </button>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 justify-center">
                            <button onclick="alert('æ­£åœ¨ä¸‹è½½å·¥ç¨‹åŒ…...')" class="px-8 py-3 bg-emerald-800 text-white rounded-lg shadow hover:bg-emerald-900 transition">
                                <i class="fa-solid fa-download mr-2"></i> å¯¼å‡º 2D å·¥ç¨‹å›¾
                            </button>
                            <button onclick="app.reset()" class="px-8 py-3 border border-stone-300 text-stone-600 rounded-lg hover:bg-stone-50 transition">
                                <i class="fa-solid fa-house mr-2"></i> è¿”å›é¦–é¡µ
                            </button>
                        </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                    </div>
                `;
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>